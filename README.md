# BPMN Fragment & Mask Transformer

A Node.js CLI that **transforms BPMN 2.0 XML files** by either:

- **Fragmenting** tasks into BPMN groups based on coupling thresholds, or
- **Masking** tasks based on privacy values.

It preserves BPMN-DI data so that the output remains viewable in BPMN modelers (Camunda Modeler, bpmn.io, etc.).

---

## üß© Installation

```bash
npm init -y
npm i @xmldom/xmldom xpath
```

Requires **Node.js 16+**.

Optionally make the script executable:

```bash
chmod +x transform.js
```

---

## üöÄ Usage

```bash
# Fragment mode (default)
node transform.js IN.bpmn OUT.bpmn --mode=fragment --threshold=0.7 [--no-singletons] [--clear-old]

# Mask mode (remove tasks by privacy value)
node transform.js IN.bpmn OUT.bpmn --mode=mask --privacy=0.5 [--privacy-dir=above|below] [--clear-old]
```

### Options

| Flag | Description | Default |
|------|-------------|---------|
| `--mode=fragment\|mask` | Operation to perform. | `fragment` |
| `--threshold=<num>` | Minimum `cpl:coupling` on sequence flows to group tasks. | `0.7` |
| `--no-singletons` | Skip groups with only one task (fragment mode). | Off |
| `--privacy=<num>` | Privacy threshold for masking. | `0.5` |
| `--privacy-dir=above\|below` | Mask tasks with `cpl:privacy ‚â•` or `<` threshold. | `below` |
| `--clear-old` | Remove previously generated fragments/annotations before running. | Off |

---

## üß† What It Expects

### Namespaces

The BPMN XML must declare these:

```xml
xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
xmlns:cpl="http://example.com/schema/coupling"
```

### Fragment Mode

- Groups tasks linked by `bpmn:sequenceFlow` with `cpl:coupling` ‚â• threshold.
- Supported task types: `task`, `userTask`, `serviceTask`, `scriptTask`, `manualTask`, `businessRuleTask`, `sendTask`, `receiveTask`.
- Each fragment:
  - Becomes a `bpmn:group` under a shared category `Category_Fragments`.
  - Includes `cpl:fragmentName`, `cpl:fragmentSize`, and `cpl:couplingThreshold`.
  - Adds a `TextAnnotation` near the group with a ‚Äúsize=‚Äù label.
  - Includes BPMN-DI shape so it renders in modelers.

### Mask Mode

- Removes tasks with a `cpl:privacy` value that matches the direction rule:
  - `--privacy-dir=above`: remove tasks with privacy ‚â• threshold.
  - `--privacy-dir=below`: remove tasks with privacy < threshold.
- Auto-creates bypass flows between unmasked predecessors and successors.
- Cleans up associations and any orphaned annotations/DI.

---

## üí° Examples

### Fragmenting

```bash
node transform.js examples/small.bpmn out.bpmn --mode=fragment --threshold=0.8
```

### Fragmenting (no singletons, clear old)

```bash
node transform.js examples/small.bpmn out.bpmn --mode=fragment --threshold=0.6 --no-singletons --clear-old
```

### Masking

```bash
node transform.js example/small.bpmn out.bpmn --mode=mask --privacy=0.7 --privacy-dir=above
```

---

## üßæ Output

- Valid BPMN 2.0 XML with:
  - New `bpmn:group` elements and DI shapes in **fragment** mode.
  - `TextAnnotation` and `bpmn:association` for fragment labels.
  - Auto-generated bypass `bpmn:sequenceFlow` edges in **mask** mode.
- If no `<bpmndi:BPMNPlane>` exists, one is automatically created.

---

## ‚öôÔ∏è Notes

- Always back up your original BPMN file before using `--clear-old` or `--mode=mask`.
- If a task lacks DI bounds, defaults are used to compute group boxes.
- Operates on the **first** `<bpmn:process>` in the XML.
- Non-numeric coupling/privacy attributes are ignored.
- Ensure the `cpl` namespace remains declared at the root of your model.

---

## üßë‚Äçüíª Development

Single-file utility:

```
transform.js
```

Dependencies:

- `@xmldom/xmldom`
- `xpath`

Run quick checks:

```bash
node transform.js sample.bpmn out.bpmn --mode=fragment --threshold=0.7 --clear-old
node transform.js sample.bpmn out-masked.bpmn --mode=mask --privacy=0.5 --privacy-dir=below
```

---

## üìÑ License

MIT
